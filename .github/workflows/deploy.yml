name: Deploy to AWS

on:
  push:
    branches: [master]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  LAMBDA_FUNCTION_NAME: aws-cost-auditor-api
  LAMBDA_ROLE_NAME: aws-cost-auditor-lambda-role

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Build frontend
        working-directory: ./frontend
        run: npm run build -- --configuration=production --base-href /apps/aws-cost-auditor-frontend/

      - name: Install backend dependencies
        working-directory: ./backend
        run: npm ci

      - name: Build backend
        working-directory: ./backend
        run: npm run build

      - name: Upload frontend artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist/aws-cost-auditor/browser

      - name: Upload backend artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-dist
          path: |
            backend/dist
            backend/package.json
            backend/package-lock.json

  deploy-frontend:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: dist

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-west-2

      - name: Deploy to S3
        run: |
          aws s3 sync dist/ s3://sitewebtree/gerard-nouglozeh/apps/aws-cost-auditor-frontend/ --delete --cache-control "max-age=31536000" --exclude "index.html"
          aws s3 cp dist/index.html s3://sitewebtree/gerard-nouglozeh/apps/aws-cost-auditor-frontend/index.html --cache-control "no-cache, no-store, must-revalidate"

      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation --distribution-id EFN7C5SV4CGJT --paths "/apps/aws-cost-auditor-frontend/*"

  deploy-backend:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download backend artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-dist
          path: backend

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install production dependencies
        working-directory: ./backend
        run: npm ci --production

      - name: Create Lambda deployment package
        working-directory: ./backend
        run: zip -r ../lambda-package.zip dist/ node_modules/ package.json

      - name: Create IAM Role if not exists
        run: |
          if ! aws iam get-role --role-name $LAMBDA_ROLE_NAME 2>/dev/null; then
            echo '{"Version":"2012-10-17","Statement":[{"Effect":"Allow","Principal":{"Service":"lambda.amazonaws.com"},"Action":"sts:AssumeRole"}]}' > trust-policy.json
            aws iam create-role --role-name $LAMBDA_ROLE_NAME --assume-role-policy-document file://trust-policy.json
            aws iam attach-role-policy --role-name $LAMBDA_ROLE_NAME --policy-arn arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
            aws iam attach-role-policy --role-name $LAMBDA_ROLE_NAME --policy-arn arn:aws:iam::aws:policy/ReadOnlyAccess
            sleep 10
          fi

      - name: Create or Update Lambda
        run: |
          ROLE_ARN=$(aws iam get-role --role-name $LAMBDA_ROLE_NAME --query 'Role.Arn' --output text)
          if aws lambda get-function --function-name $LAMBDA_FUNCTION_NAME 2>/dev/null; then
            aws lambda update-function-code --function-name $LAMBDA_FUNCTION_NAME --zip-file fileb://lambda-package.zip
          else
            aws lambda create-function --function-name $LAMBDA_FUNCTION_NAME --runtime nodejs20.x --role $ROLE_ARN --handler dist/index.handler --zip-file fileb://lambda-package.zip --timeout 300 --memory-size 512
            aws lambda wait function-active --function-name $LAMBDA_FUNCTION_NAME
            aws lambda create-function-url-config --function-name $LAMBDA_FUNCTION_NAME --auth-type NONE --cors '{"AllowOrigins":["*"],"AllowMethods":["GET","POST","OPTIONS"],"AllowHeaders":["Content-Type","Authorization","X-AWS-Access-Key-Id","X-AWS-Secret-Access-Key","X-AWS-Session-Token","X-AWS-Region"]}'
            aws lambda add-permission --function-name $LAMBDA_FUNCTION_NAME --statement-id FunctionURLAllowPublicAccess --action lambda:InvokeFunctionUrl --principal "*" --function-url-auth-type NONE
          fi

      - name: Get Lambda URL
        run: |
          URL=$(aws lambda get-function-url-config --function-name $LAMBDA_FUNCTION_NAME --query 'FunctionUrl' --output text 2>/dev/null || echo "N/A")
          echo "Lambda Function URL: $URL"
